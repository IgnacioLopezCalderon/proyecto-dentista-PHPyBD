{% extends "admin_base.twig" %}

{% block titulo %}Detalle Cita{% endblock %}

{% block estilos_extra %}
    <style>
        /* Estilos locales para limpiar el HTML */
        .encabezado { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }

        .btn-gray { background-color: #666; }
        .btn-cobrar { width: 100%; display: block; text-align: center; font-size: 1.1rem; padding: 15px; margin-top: 20px; }

        .grid-layout { display: flex; gap: 30px; flex-wrap: wrap; margin-top: 20px; }
        .columna { flex: 1; min-width: 300px; }

        .card-datos { background: #f9f9f9; padding: 20px; border-radius: 8px; border: 1px solid #eee; }

        .precio-col { text-align: right; }
        .total { text-align: right; font-size: 1.5rem; font-weight: bold; margin-top: 20px; color: #333; }

        .aviso-finalizada { margin-top: 20px; text-align: center; padding: 15px; background: #e8f4fd; color: #0056b3; border-radius: 5px; font-weight: bold; }
    </style>
{% endblock %}

{% block contenido %}

    <div class="encabezado">
        <h1>Ficha Cita #{{ cita.id_cita }}</h1>
        <a href="/admin/citas/aceptadas" class="btn btn-gray">‚¨Ö Volver</a>
    </div>

    <div class="grid-layout">

        <div class="columna">
            <div class="card-datos">
                <h3>üë§ Paciente</h3>
                <p style="font-size:1.1rem; margin-bottom:5px;">
                    <strong>{{ cita.nombre_paciente }} {{ cita.apellido_paciente }}</strong>
                </p>
                <p style="color:#666; margin-bottom:15px;">{{ cita.email }}</p>

                <hr style="border:0; border-top:1px solid #ddd; margin:15px 0;">

                <h3>üìÖ Datos Cita</h3>
                <p><strong>Fecha:</strong> {{ cita.fecha_cita | date("d/m/Y") }}</p>
                <p><strong>Hora:</strong> {{ cita.fecha_cita | date("H:i") }}</p>
                <p><strong>Estado:</strong>
                    {% if cita.nombre_estado == 'Finalizada' %}
                        <span style="color:blue; font-weight:bold;">Finalizada</span>
                    {% else %}
                        <span style="color:green; font-weight:bold;">Confirmada</span>
                    {% endif %}
                </p>
            </div>
        </div>

        <div class="columna">
            <h3>üõ†Ô∏è Servicios a Cobrar</h3>

            <table>
                <thead>
                <tr>
                    <th>Concepto</th>
                    <th class="precio-col">Precio</th>
                </tr>
                </thead>
                <tbody>
                {% set total = 0 %}
                {% for servicio in serviciosRealizados %}
                    <tr>
                        <td>{{ servicio.tipo }}</td>
                        <td class="precio-col">{{ servicio.precio }} ‚Ç¨</td>
                    </tr>
                    {% set total = total + servicio.precio %}
                {% else %}
                    <tr><td colspan="2" style="text-align:center; padding:20px; color:#777;">Sin servicios detallados</td></tr>
                {% endfor %}
                </tbody>
            </table>

            <div class="total">
                Total: {{ total }} ‚Ç¨
            </div>

            {% if cita.nombre_estado != 'Finalizada' %}
                <a href="/admin/citas/finalizar?id={{ cita.id_cita }}"
                   class="btn btn-blue btn-cobrar"
                   onclick="return confirm('¬øConfirmas que el cliente ha pagado {{ total }}‚Ç¨? La cita se cerrar√°.');">
                    ‚úÖ Cobrar y Finalizar Cita
                </a>
            {% else %}
                <div class="aviso-finalizada">
                    ‚úÖ Esta cita ya ha sido cobrada y cerrada.
                </div>
            {% endif %}
        </div>
    </div>
{% endblock %}